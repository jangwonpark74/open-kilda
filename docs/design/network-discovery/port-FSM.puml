Internal state:
* remote endpoint (swId + port) (initial not set)
* online (boolean) (initial true)

Input signals:
* port-up
* port-down
* port-managed
* port-unmanaged
* discovery-timer
* discovery
* discovery-pushed
* enable
* disable
* online
* offline

Output signals:
* discovery (proxy)
* isl-down
* isl-disable
* isl-move
* isl-push-fail (?)
* isl-unmanaged
* push-discovery

@startuml
[*] --> INIT

INIT -r-> PREPOPULATE : history
INIT --> BECOME_OFFLINE : offline
INIT --> OPERATIONAL : online

PREPOPULATE -l-> INIT : next
PREPOPULATE : enter / set remote
PREPOPULATE : enter / emit isl-setup

state OPERATIONAL {
    [*] --> UNKNOWN

    UNKNOWN --> DOWN : port-down
    UNKNOWN --> UP : port-up
    UNKNOWN : enter / set online true

    UP --> DOWN : port-down
    UP --> makeDiscovery : discovery-timer
    UP --> DISCOVERED : discovery

    makeDiscovery : enter / push-discovery
    makeDiscovery --> UP : next

    DOWN --> UP : port-up

    state DISCOVERED {
        DISCOVERED : enter / record remote if unset
        DISCOVERED : enter / emit discovery
        DISCOVERED : exit / emit isl-down

        state checkMoved <<choice>>

        [*] --> MAIN
        
        MAIN --> checkMoved : discovery
        MAIN --> PROXY : discovery-pushed

        checkMoved --> CONFIRM_DISCOVERY : if same remote
        checkMoved --> MOVED : if remote changed

        PROXY --> MAIN : next
        PROXY : enter / emit discovery-pushed

        MOVED --> CONFIRM_DISCOVERY : next
        MOVED : enter / emit isl-move
        MOVED : enter / record remote
        MOVED : enter / emit isl-setup

        CONFIRM_DISCOVERY --> MAIN : next
        CONFIRM_DISCOVERY : enter / emit discovery
    }
    DISCOVERED --> DOWN : port-down
}

OPERATIONAL --> BECOME_OFFLINE : offline
OPERATIONAL --> BECOME_DISABLED : disable
OPERATIONAL --> BECOME_UNMANAGED : port-unmanaged

BECOME_OFFLINE --> UNOPERATIONAL : next
BECOME_OFFLINE : enter / set online = false

BECOME_DISABLED --> UNOPERATIONAL : next
BECOME_DISABLED : enter / set enabled = false
BECOME_DISABLED : enter / emit isl-disable if have remote

BECOME_UNMANAGED --> UNOPERATIONAL : next
BECOME_UNMANAGED : enter / set managed = false
BECOME_UNMANAGED : enter / emit isl-unmanaged if have remote

state UNOPERATIONAL {
    [*] --> PENDING

    state OPERATIONAL_DECISION <<choice>>

    PENDING --> ONLINE_SWITCH : online
    PENDING --> ONLINE_SWITCH : offline
    PENDING --> ENABLE_SWITCH : disable
    PENDING --> ENABLE_SWITCH : enable
    PENDING --> MANAGED_SWITCH : port-unmanaged
    PENDING --> MANAGED_SWITCH : port-managed

    ONLINE_SWITCH --> OPERATIONAL_DECISION : next
    ONLINE_SWITCH : enter / set online = (true|false)

    ENABLE_SWITCH --> OPERATIONAL_DECISION : next
    ENABLE_SWITCH : enter / set enabled = (true|false)

    MANAGED_SWITCH --> OPERATIONAL_DECISION : next
    MANAGED_SWITCH : enter / set managed = (true|false)

    OPERATIONAL_DECISION --> PENDING : else
    OPERATIONAL_DECISION -u-> OPERATIONAL : all flags are true
}

@enduml
